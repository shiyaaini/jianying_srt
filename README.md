# 剪映字幕对齐工具

这是一个用于调整剪映工程文件中字幕时长的PyQt5应用程序，可以解决文本转语音后音频时长与字幕显示时长不匹配的问题。

## 功能特点

### 主要功能
- 🎬 **工程文件解析**：自动解析剪映 `draft_content.json` 工程文件
- 📁 **智能工程选择**：提供工程选择弹窗，支持关键字搜索和自动扫描
- ⏰ **时长对齐**：根据音频实际时长调整字幕显示时长
- 🔧 **多种对齐方式**：支持音频时长对齐、按比例调整、手动调整、连续排序
- 🚫 **重叠处理**：智能处理字幕重叠问题，提供多种解决方案
- 🎛️ **轨道合并**：智能合并多个轨道，优化工程结构
- 🧹 **空轨道清理**：自动清理没有内容的空轨道
- 📤 **字幕导出**：支持导出SRT、LRC、ASS、TXT等多种字幕格式
- 📋 **智能表格**：自动调整列宽，支持排序、筛选和手动调整
- 💾 **安全保存**：自动备份原文件，安全保存修改结果

### 对齐方式
1. **根据音频时长对齐**：直接将字幕时长设置为对应音频的时长
2. **按比例调整**：按设定比例调整字幕时长（如1.2倍）
3. **手动调整**：保留原设置，用户可在界面中查看差异
4. **连续排序**：将字幕和音频按原始顺序连续排列，支持微秒级间隔控制，适用于小说朗读等连续内容

### 重叠处理策略
1. **后移重叠片段**：将时间靠后的字幕-音频对整体向后移动，使用最小间隔（1微秒）避免重叠
2. **前后微调**：前面的字幕-音频对缩短时长，后面的字幕-音频对延后开始时间
3. **压缩时长**：两个重叠的字幕-音频对都适当缩短时长
4. **忽略重叠**：不处理重叠问题

### 智能跳过机制
- **容忍度**：小于设定值（微秒）的重叠被视为可接受，不进行处理
- **跳过阈值**：超过设定值（微秒）的重叠被视为过于严重，自动跳过处理
- **一对一同步**：字幕和音频作为一个整体进行处理，保持完美同步
- **微秒精度**：支持微秒级精确控制，可根据需要调节更多参数

### 轨道管理功能
1. **智能合并**：将无重叠的字幕和音频片段合并到同一轨道
2. **自动清理**：删除没有内容的空轨道，优化工程结构
3. **轨道显示**：在界面中显示每个字幕和音频所在的轨道信息
4. **手动操作**：提供"合并轨道"按钮，可随时执行轨道合并和清理操作
5. **对齐后操作**：提供下拉选择，可设置对齐完成后的自动操作：
   - 仅对齐，不执行其他操作
   - 对齐后自动合并轨道
   - 对齐后合并轨道并清理空轨道

### 工程选择功能
1. **智能扫描**：自动扫描剪映工程目录，发现所有工程文件
2. **关键字搜索**：支持按工程名称关键字快速筛选
3. **详细信息**：显示工程修改时间、时长、字幕数量等信息
4. **路径管理**：支持自定义工程目录路径，记住用户设置
5. **快速访问**：双击选择工程，支持打开工程所在目录

## 安装要求

```bash
pip install PyQt5
```

## 使用方法

### 1. 启动程序
```bash
python subtitle_aligner.py
```

### 2. 选择工程文件

#### 方式一：智能选择（推荐）
- 点击"选择工程"按钮打开工程选择弹窗
- 程序会自动扫描默认剪映工程目录
- 使用关键字搜索快速找到目标工程
- 双击工程或点击"选择"按钮确认

#### 方式二：手动加载
- 点击"手动加载"按钮
- 手动选择 `draft_content.json` 文件
- 工程文件通常位于：`C:\Users\{用户名}\AppData\Local\JianyingPro\User Data\Projects\com.lveditor.draft\{工程名称}\draft_content.json`
pip install --index-url https://download.pytorch.org/whl/cu121 torch torchvision torchaudio

### 3. 配置对齐参数
- **对齐方法**：选择合适的对齐策略
- **调整比例**：当选择"按比例调整"时，设置比例值
- **容忍度**：设置重叠容忍度（毫秒），小于此值的重叠将被忽略
- **处理方法**：选择重叠冲突的解决方案
- **轨道合并**：勾选"对齐后自动合并轨道"和"清理空轨道"

### 4. 执行对齐
- 点击"执行对齐"按钮开始处理
- 查看进度条和操作日志
- 处理完成后查看结果表格
- 如果启用了自动合并，轨道会自动优化

### 5. 重叠处理（可选）
- 设置重叠容忍度（毫秒）：小于此值的重叠将被忽略
- 设置跳过阈值（毫秒）：大于此值的重叠将被跳过不处理
- 选择处理方法：后移重叠片段、前后微调、压缩时长、忽略重叠
- 点击"处理重叠"按钮手动处理重叠问题
- **一对一同步**：字幕-音频对作为整体进行处理，保持完美同步

### 6. 轨道管理（可选）
- 点击"合并轨道"按钮手动合并轨道
- 查看轨道信息列，了解片段分布情况

### 7. 保存结果
- 点击"保存工程"按钮保存修改
- 原文件会自动备份为 `.backup` 后缀

## 界面说明

### 主界面布局
- **工具栏**：包含选择工程、手动加载、刷新、对齐、合并轨道、保存等操作按钮
- **字幕列表**：显示所有字幕与音频的配对信息和轨道状态
- **配置面板**：设置对齐参数、轨道合并和重叠处理策略
- **操作日志**：显示处理过程和结果信息

### 字幕列表字段说明
- **序号**：字幕序号
- **文本内容**：字幕文本内容（超长时截断显示）
- **字幕时长**：当前字幕显示时长（毫秒）
- **音频时长**：对应音频的实际时长（毫秒）
- **字幕开始时间**：字幕开始显示的时间点（毫秒）
- **音频开始时间**：音频开始播放的时间点（毫秒）
- **文本轨道**：字幕所在的轨道编号
- **音频轨道**：音频所在的轨道编号
- **状态**：显示时长差异或其他状态信息

## 数据结构说明

### 剪映工程文件结构
剪映的 `draft_content.json` 文件包含以下主要结构：

#### 文本信息
- 位置：`materials.texts`
- 包含：文本内容、样式、字体等信息
- 关键字段：`id`（文本ID）、`content`（文本内容）

#### 音频信息  
- 位置：`materials.audios`
- 包含：音频文件路径、时长等信息
- 关键字段：`id`（音频ID）、`text_id`（关联的文本ID）、`duration`（时长）、`path`（文件路径）

#### 轨道信息
- 位置：`tracks`
- 包含：时间轴上的片段信息
- 文本轨道：`type: "text"`，控制字幕显示时间和位置
- 音频轨道：`type: "audio"`，控制音频播放时间

#### 时间参数
- `target_timerange.start`：开始时间（微秒）
- `target_timerange.duration`：持续时间（微秒）
- 注意：剪映使用微秒为单位，1秒 = 1,000,000微秒

## 注意事项

1. **备份重要**：程序会自动创建备份，但建议手动备份重要工程文件
2. **路径处理**：音频文件路径可能包含占位符，程序会自动处理
3. **时间单位**：内部计算使用微秒，界面显示为毫秒
4. **兼容性**：适用于剪映专业版 5.x 版本的工程文件

## 故障排除

### 常见问题
1. **加载失败**：检查文件是否为有效的剪映工程文件
2. **找不到音频**：确认音频文件存在于工程目录的 `textReading` 文件夹中
3. **对齐效果不理想**：尝试调整容忍度和重叠处理策略

### 错误日志
程序会在界面的操作日志区域显示详细的错误信息，有助于问题诊断。

## 技术实现

- **语言**：Python 3.x
- **GUI框架**：PyQt5
- **数据处理**：JSON解析和操作
- **多线程**：使用QThread避免界面卡顿

## 更新历史

- **v1.0.0**：初始版本，支持基本的字幕时长对齐功能

## 许可证

本项目仅供学习和个人使用，请遵守相关法律法规。
